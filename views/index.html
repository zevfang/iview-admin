<!-- MarkerList完整示例 -->
<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>完整示例</title>
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/demo-center.css" type="text/css">
    <style>
        html,body,#container{
            height: 100%
        }
        .input-item{
            height: 2.2rem;
        }
        .btn{
            width: 6rem;
            margin: 0 1rem 0 2rem;
        }
        .input-text{
            width: 4rem;
            margin-right:1rem;
        }
    </style>
</head>

<body>
<div id="outer-box">
    <div id="container" tabindex="0"></div>
    <div id="panel" class="scrollbar1">
        <div style="height: 100px;padding: 10px">
            <select id="locals" name="locals" style="width:100%">
                <option value="-1">请选择区域</option>
            </select>
        </div>

        <ul id="myList">
        </ul>
    </div>

    <div class="input-card" style='width: 24rem;'>
        <div class="input-item">
            <input type="radio" name='func' checked="" value='marker'><span class="input-text">画点</span>
            <input type="radio" name='func' value='polyline'><span class="input-text">画折线</span>
            <input type="radio" name='func' value='polygon'><span class="input-text" style='width:5rem;'>画多边形</span>
        </div>
        <div class="input-item">
            <input type="radio" name='func' value='rectangle'><span class="input-text">画矩形</span>
            <input type="radio" name='func' value='circle'><span class="input-text">画圆</span>
        </div>
        <div class="input-item">
            <input id="clear" type="button" class="btn" value="清除" />
            <input id="close" type="button" class="btn" value="关闭绘图" />

        </div>
        <div class="input-item">
            <button class="btn" onclick="polyEditor.open()" style="margin-bottom: 5px">开始编辑</button>
            <button class="btn" onclick="polyEditor.close()">结束编辑</button>
        </div>
        <div class="input-item">
            <input id="addOverlayGroup" type="button" class="btn" value="添加覆盖物群组"/>
            <input id="removeOverlayGroup" type="button" class="btn" value="移除覆盖物群组"/>
        </div>
    </div>

    <ul id="btnList">
        <li>
            <input value="美食数据" type="button" data-path="//a.amap.com/amap-ui/static/data/restaurant.json" />
        </li>
        <li>
            <input value="酒店数据" type="button" data-path="//a.amap.com/amap-ui/static/data/hotel.json" />
        </li>
        <li>
            <input value="选中第一个" type="button" data-enable='markerList.getData().length>0' data-eval='markerList.selectByDataIndex(0)' />
        </li>
        <li>
            <input value="选中最后一个" type="button" data-enable='markerList.getData().length>0' data-eval='markerList.selectByDataReverseIndex(0)' />
        </li>
        <li>
            <input value="清除选中" type="button" data-enable='!!markerList.getSelectedDataId()' data-eval='markerList.clearSelected()' />
        </li>
        <li>
            <input value="清除数据" type="button" data-enable='markerList.getData().length>0' data-eval='markerList.clearData()' />
        </li>
    </ul>
</div>

<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=您申请的key值&plugin=AMap.MouseTool,AMap.PolyEditor"></script>

<!-- UI组件库 1.0 -->
<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>


<script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>


<script type="text/javascript">
   $(function () {
       var locals_data = [
           {
               id: 0,
               text: '王府井',
               points:[
                   [1.12,1.33],
                   [1.12,1.33],
               ],
               cent:[2.34,2234]
           },
           {
               id: 2,
               text: '西单',
               points:[
                   [1.12,1.33],
                   [1.12,1.33],
               ],
               cent:[2.44,2234]
           }
       ];
       //################区域下拉框################
       var localSelect = $("#locals")
       localSelect.select2({
           language: {
               inputTooShort: function () {
                   return "无区域数据.";
               }
           },

          // allowClear: true,
          // minimumInputLength: 1,
           width: 'resolve',
           data: locals_data,
           // ajax: {
           //     url: "https://api.github.com/search/repositories",
           //     dataType: 'json',
           //     delay: 250,
           //     data: function (params) {
           //         return {
           //             q: params.term, // search term
           //             page: params.page
           //         };
           //     },
           //     processResults: function (data, params) {
           //         // parse the results into the format expected by Select2
           //         // since we are using custom formatting functions we do not need to
           //         // alter the remote JSON data, except to indicate that infinite
           //         // scrolling can be used
           //         params.page = params.page || 1;
           //
           //         return {
           //             results: data.items,
           //             pagination: {
           //                 more: (params.page * 30) < data.total_count
           //             }
           //         };
           //     },
           //     cache: true
           // },

       });

       localSelect.on('select2:select', function (e) {
           var data = e.params.data;
           console.log("切换")
           console.log(data);
       });

       localSelect.on('select2:close', function (e) {
           console.log("2s内不允许再次切换.")
       });



       //################创建地图################
       var map = new AMap.Map('container', {
           zoom: 9,
           //center: [116.43, 39.92],
           resizeEnable: true
       });

       map.setDefaultCursor("crosshair");
       map.setCity("北京");

       //绘制列表
       AMapUI.loadUI(['misc/MarkerList', 'overlay/SimpleMarker', 'overlay/SimpleInfoWindow'], function(MarkerList, SimpleMarker, SimpleInfoWindow) {

           //即jQuery/Zepto
           var $ = MarkerList.utils.$;

           var defaultIconStyle = 'red', //默认的图标样式
               hoverIconStyle = 'green', //鼠标hover时的样式
               selectedIconStyle = 'purple' //选中时的图标样式
           ;

           var markerList = new MarkerList({
               map: map,
               //ListElement对应的父节点或者ID
               listContainer: "myList", //document.getElementById("myList"),
               //选中后显示

               //从数据中读取位置, 返回lngLat
               getPosition: function(item) {
                   return [item.longitude, item.latitude];
               },
               //数据ID，如果不提供，默认使用数组索引，即index
               getDataId: function(item, index) {

                   return item.id;
               },
               getInfoWindow: function(data, context, recycledInfoWindow) {

                   if (recycledInfoWindow) {

                       recycledInfoWindow.setInfoTitle(data.name);
                       recycledInfoWindow.setInfoBody(data.address);

                       return recycledInfoWindow;
                   }

                   return new SimpleInfoWindow({
                       infoTitle: data.name,
                       infoBody: data.address,
                       offset: new AMap.Pixel(0, -37)
                   });
               },
               //构造marker用的options对象, content和title支持模板，也可以是函数，返回marker实例，或者返回options对象
               getMarker: function(data, context, recycledMarker) {

                   var label = String.fromCharCode('A'.charCodeAt(0) + context.index);

                   if (recycledMarker) {
                       recycledMarker.setIconLabel(label);
                       return;
                   }

                   return new SimpleMarker({
                       containerClassNames: 'my-marker',
                       iconStyle: defaultIconStyle,
                       iconLabel: label
                   });
               },
               //构造列表元素，与getMarker类似，可以是函数，返回一个dom元素，或者模板 html string
               getListElement: function(data, context, recycledListElement) {

                   var label = String.fromCharCode('A'.charCodeAt(0) + context.index);

                   //使用模板创建
                   var innerHTML = MarkerList.utils.template('<div class="poi-imgbox">' +
                       '    <span class="poi-img" style="background-image:url(<%- data.pic %>)"></span>' +
                       '</div>' +
                       '<div class="poi-info-left">' +
                       '    <h3 class="poi-title">' +
                       '        <%- label %>. <%- data.name %>' +
                       '    </h3>' +
                       '    <div class="poi-info">' +
                       '        <span class="poi-price">' +
                       '            <%= data.price %>' +
                       '        </span>' +
                       '        <p class="poi-addr"><%- data.address %></p>' +
                       '    </div>' +
                       '</div>' +
                       '<div class="clear"></div>', {
                       data: data,
                       label: label
                   });

                   if (recycledListElement) {
                       recycledListElement.innerHTML = innerHTML;
                       return recycledListElement;
                   }

                   return '<li class="poibox">' +
                       innerHTML +
                       '</li>';
               },
               //列表节点上监听的事件
               listElementEvents: ['click', 'mouseenter', 'mouseleave'],
               //marker上监听的事件
               markerEvents: ['click', 'mouseover', 'mouseout'],
               //makeSelectedEvents:false,
               selectedClassNames: 'selected',
               autoSetFitView: true
           });

           window.markerList = markerList;

           markerList.on('selectedChanged', function(event, info) {

               checkBtnStats();

               if (info.selected) {

                   console.log(info);

                   if (info.selected.marker) {
                       //更新为选中样式
                       info.selected.marker.setIconStyle(selectedIconStyle);
                   }

                   //选中并非由列表节点上的事件触发，将关联的列表节点移动到视野内
                   if (!info.sourceEventInfo.isListElementEvent) {

                       if (info.selected.listElement) {
                           scrollListElementIntoView($(info.selected.listElement));
                       }
                   }
               }

               if (info.unSelected && info.unSelected.marker) {
                   //更新为默认样式
                   info.unSelected.marker.setIconStyle(defaultIconStyle);
               }
           });

           markerList.on('listElementMouseenter markerMouseover', function(event, record) {

               if (record && record.marker) {

                   forcusMarker(record.marker);

                   //this.openInfoWindowOnRecord(record);

                   //非选中的id
                   if (!this.isSelectedDataId(record.id)) {
                       //设置为hover样式
                       record.marker.setIconStyle(hoverIconStyle);
                       //this.closeInfoWindow();
                   }
               }
           });

           markerList.on('listElementMouseleave markerMouseout', function(event, record) {

               if (record && record.marker) {

                   if (!this.isSelectedDataId(record.id)) {
                       //恢复默认样式
                       record.marker.setIconStyle(defaultIconStyle);
                   }
               }
           });

           //数据输出完成
           markerList.on('renderComplete', function(event, records) {

               checkBtnStats();
           });

           // markerList.on('*', function(type, event, res) {
           //     console.log(type, event, res);
           // });

           //加载数据
           function loadData(src, callback) {

               $.getJSON(src, function(data) {

                   markerList._dataSrc = src;

                   //渲染数据
                   markerList.render(data);

                   if (callback) {
                       callback(null, data);
                   }
               });
           }

           var $btns = $('#btnList input[data-path]');

           /**
            * 检测各个button的状态
            */
           function checkBtnStats() {
               $('#btnList input[data-enable]').each(function() {

                   var $input = $(this),
                       codeEval = $input.attr('data-enable');

                   $input.prop({
                       disabled: !eval(codeEval)
                   });
               });
           }

           $('#btnList').on('click', 'input', function() {

               var $input = $(this),
                   dataPath = $input.attr('data-path'),
                   codeEval = $input.attr('data-eval');

               if (dataPath) {
                   loadData(dataPath);
               } else if (codeEval) {
                   eval(codeEval);
               }

               checkBtnStats();
           });

           loadData($btns.attr('data-path'));

           function forcusMarker(marker) {
               marker.setTop(true);

               //不在地图视野内
               if (!(map.getBounds().contains(marker.getPosition()))) {

                   //移动到中心
                   map.setCenter(marker.getPosition());
               }
           }

           function isElementInViewport(el) {
               var rect = el.getBoundingClientRect();

               return (
                   rect.top >= 0 &&
                   rect.left >= 0 &&
                   rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /*or $(window).height() */
                   rect.right <= (window.innerWidth || document.documentElement.clientWidth) /*or $(window).width() */
               );
           }

           function scrollListElementIntoView($listEle) {

               if (!isElementInViewport($listEle.get(0))) {
                   $('#panel').scrollTop($listEle.offset().top - $listEle.parent().offset().top);
               }

               //闪动一下
               $listEle
                   .one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
                       function(e) {
                           $(this).removeClass('flash animated');
                       }).addClass('flash animated');
           }


       });




       //###############创建右键菜单
       var contextMenu = new AMap.ContextMenu();

       //右键放大
       contextMenu.addItem("放大一级", function () {
           map.zoomIn();
       }, 0);

       //右键缩小
       contextMenu.addItem("缩小一级", function () {
           map.zoomOut();
       }, 1);


       //###############添加群组
       var lnglats = [[116.482874, 39.98612], [116.483874, 39.98612], [116.450874, 39.98612]];
       var markers = [];

       for (var i = 0; i < lnglats.length; i++) {
           var lnglat = lnglats[i];
           // 创建点实例
           var marker = new AMap.Marker({
               position: new AMap.LngLat(lnglat[0], lnglat[1]),
               icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b' + (i + 1) + '.png',
               extData: {
                   id: i + 1
               }
           });

           //绑定鼠标右击事件——弹出右键菜单
           marker.on('rightclick', function (e) {
               contextMenu.open(map, e.lnglat);
           });

           markers.push(marker);
       }

       // 创建覆盖物群组，并将 marker 传给 OverlayGroup
       var overlayGroups = new AMap.OverlayGroup(markers);

       // 绑定事件
       document.getElementById("addOverlayGroup").onclick =  function addOverlayGroup() {

           map.add(overlayGroups);
       }

       document.getElementById("removeOverlayGroup").onclick =   function removeOverlayGroup() {
           map.remove(overlayGroups);
       }


       //###############绘制多边形
       var mouseTool = new AMap.MouseTool(map)
       mouseTool.polygon({
           strokeColor: "#FF33FF",
           strokeOpacity: 1,
           strokeWeight: 6,
           strokeOpacity: 0.2,
           fillColor: '#1791fc',
           fillOpacity: 0.4,
           // 线样式还支持 'dashed'
           strokeStyle: "solid",
           // strokeStyle是dashed时有效
           // strokeDasharray: [30,10],
       })

       mouseTool.on('draw', function(polygon) {
           // event.obj 为绘制出来的覆盖物对象
           //alert('覆盖物对象绘制完成')
           console.log(polygon.obj.getPath())

       })

       var path = [
           [116.403322, 39.920255],
           [116.410703, 39.897555],
           [116.402292, 39.892353],
           [116.389846, 39.891365]
       ]
       editor(map,path)


       //###############GEO绘制###############
       ajax('https://a.amap.com/jsapi_demos/static/geojson/chongqing.json', function(err, geoJSON) {
           if (!err) {
               var geojson = new AMap.GeoJSON({
                   geoJSON: geoJSON,
                   // 还可以自定义getMarker和getPolyline
                   getPolygon: function(geojson, lnglats) {
                       // 计算面积
                       var area = AMap.GeometryUtil.ringArea(lnglats[0])

                       return new AMap.Polygon({
                           path: lnglats,
                           fillOpacity: 1 - Math.sqrt(area / 8000000000),// 面积越大透明度越高
                           strokeColor: 'white',
                           fillColor: 'red'
                       });
                   }
               });

               geojson.setMap(map);

               log.success('GeoJSON 数据加载完成')
           } else {
               log.error('GeoJSON 服务请求失败')
           }
       })


       //###############选择地区###############

   });


   function editor(map,path) {
       var polygon = new AMap.Polygon({
           path: path,
           strokeColor: "#FF33FF",
           strokeWeight: 6,
           strokeOpacity: 0.2,
           fillOpacity: 0.4,
           fillColor: '#1791fc',
           zIndex: 50,
       })

       map.add(polygon)
       // 缩放地图到合适的视野级别
       map.setFitView([ polygon ])

       var polyEditor = new AMap.PolyEditor(map, polygon)

       polyEditor.on('addnode', function(event) {
           log.info('触发事件：addnode')
       })

       polyEditor.on('adjust', function(event) {
           log.info('触发事件：adjust')
       })

       polyEditor.on('removenode', function(event) {
           log.info('触发事件：removenode')
       })

       polyEditor.on('end', function(event) {
           log.info('触发事件： end')
           // event.target 即为编辑后的多边形对象
       })
   }


</script>
</body>

</html>